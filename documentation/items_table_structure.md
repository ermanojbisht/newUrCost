**SOR (Schedule of Rates) items table structure** in MySQL, focusing on hierarchy, relationships, and meaning of some fields.

---

### üìò SOR Item Table Structure (Nested Hierarchy)

The **SOR (Schedule of Rates)** system is designed to manage a hierarchical structure of items and chapters, where each SOR contains multiple chapters, and each chapter may contain sub-chapters or items.

All this hierarchical data is stored in a single table ‚Äî the **`items`** table ‚Äî which represents both **chapters** and **items** in a nested structure.
items table has more then one SOR . so for set of a sor nodes (chapter,sub-chapter,item) has a common field value of sor_id. root not of a particular SOR has parent_id as null

---

### üß© Table Overview

Each record (row) in the `items` table represents a node in this hierarchy ‚Äî it can be:

* A **root SOR** (top-level chapter)
* A **chapter** (which may have sub-chapters or items)
* An **item** (which has a rate and listed under one or more chapters , subchapters)

---

### ‚öôÔ∏è Table Fields and Their Purpose

| Field Name                    | Description                                                                                                                                                                     |
| ----------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **id**                        | Primary key. Unique identifier for each node (chapter/item).                                                                                                                    |
| **parent_id**                 | References the parent node. If `NULL`, this node is a **root SOR**.                                                                                                             |
| **sor_id**                    | Indicates which SOR the node belongs to (useful as multiple SORs share the same table).                                                                                       |
| **item_type**                 | Defines the type of the record: <br>‚Ä¢ `1` ‚Üí Root chapter (top level) <br>‚Ä¢ `2` ‚Üí Sub-chapter (nested under another chapter) <br>‚Ä¢ `3` ‚Üí Actual item (contains rate information) |
| **item_code**                 | Unique item identifier (string stored as text, though numeric). Chapters have `0` as item code.                                                                                 |
| **description**               | almost one line or a para description of the chapter or item.                                                                                                                                       |
| **name**                      | **Computed Name:** For `item_type = 3` (Actual item), the name is a hierarchical composition of its ancestors' descriptions (excluding the SOR root node, and only including ancestors with `item_type` 1 or 2), followed by the item's own `description`, separated by newlines. For `item_type` 1 or 2 (Root chapter or Sub-chapter), the name is simply its own `description`. This field is automatically generated by the `ItemObserver`. |
| **order_in_parent**           | Defines the display or sequence order of this node among its siblings (used to sort chapters/items under a parent).                                                             |
| **nested_item_level**         | **(Deprecated/Redundant)** This field is redundant as the `lft` field from the Nested Set Model provides the same ordering information. It is recommended to use `lft` for tree traversal and ordering. |
| **lft** / **rgt** / **depth** | Standard **Nested Set Model** fields for efficient hierarchical queries and ordering.                                                                                           |

---

### üå≤ Example Hierarchy

| ID | Parent ID | Item Type | Description | Order in Parent | Hierarchy                            |
| -- | --------- | --------- | ----------- | --------------- | -------------------------------------|
| 1  | NULL      | NULL      | Root SOR    | ‚Äî               | Root                                 |
| 2  | 1         | 1         | Chapter 1   | 1               | SOR ‚Üí Chapter 1                      |
| 3  | 2         | 2         | Chapter 1A  | 1               | SOR ‚Üí Chapter 1->Chapter 1A          |
| 4  | 2         | 3         | Item 1      | 1               | SOR ‚Üí Chapter 1-‚Üí Item 1             |
| 5  | 3         | 3         | Item 2      | 1               | SOR ‚Üí Ch 1->Ch 1A ‚Üí Item 2           |

---


* The table supports **any depth of nesting** ‚Äî chapters within chapters within items.
* **Chapters do not have rates**, but **items do**.
* The combination of `id`, `parent_id`, and `sor_id` defines the **full structure** of a SOR.
* **Ordering** is maintained using `order_in_parent` and is crucial for reconstructing the tree correctly via the **nested set model** (`lft`, `rgt`, `depth`).
*   The `name` field is automatically generated and maintained by the `App\Observers\ItemObserver` whenever an `Item` model is created or updated. This observer ensures the hierarchical naming conventions are consistently applied.



detailed set of **creation, editing, and deletion rules** for an SOR (Schedule of Rates) system that uses a hierarchical **items table** to store chapters, sub-chapters, and items.

## üß© SOR Items Table ‚Äì Creation, Editing & Deletion Rules

Each node type has different rules for field initialization, editability, and validation.

---


### üîπ 1. Field Grouping by Behavior

When creating or editing a record, each field falls into one of three categories:

1. **Created and editable fields** ‚Äì fields that are set when a record is created and can be modified later.
    description,short_description,order_in_parent,parent_id,item_code (0 for chapter/sub-chapter, unique for item),specification_code,specification_code, specification_page_number,item_number,assumptions, footnotes, unit_id, 
2. **Created but non-editable fields** ‚Äì fields that are initialized during creation and remain fixed afterward.
    id,sor_id,item_type
3. **Auto-calculated (system) fields** ‚Äì fields that are generated by the system automatically and cannot be edited.
    lft,rgt,depth,name,turnout_quantity,updated_by,created_by,created_at,updated_at,nested_list_order,sub_item_level,sub_item_count,is_locked,is_canceled,reference_from,sort_order

---

### üîπ 2. Field Rules During Creation

| Field                                              | Description                                                  | Default / Calculation                                        | Editable After Creation                                      |
| -------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **id**                                             | unique for table, also act as primary key                    | Auto calculated for new rows , except root node of  SOR which is same as sor's id | ‚ùå Not editable                                               |
| **sor_id**                                         | The ID of the SOR this record belongs to.                    | Set automatically from context (e.g., current SOR).          | ‚ùå Not editable                                               |
| **item_type**                                      | Defines the type of node: <br>1 = Chapter, <br>2 = Sub-chapter, <br>3 = Item | Set at creation based on user choice                         | ‚ùå Not editable                                               |
| **parent_id**                                      | The parent node‚Äôs ID (NULL for root chapter,which is SOR itself) | Set at creation. for SOR root node it will null . otherwise depend upon context where user creating the node | ‚úÖ Editable (if moved, must follow hierarchy rules)<br />item can not have another item as children |
| **item_code**                                      | Identifier for item (string stored as number)                | For chapters/sub-chapters ‚Üí always `0`. <br>For items ‚Üí auto-generated as **next available code** based on `sor_id`. Example: if last code is `6000017`, next = `6000018` for sor_id= `6`. | ‚ùå Not editable                                               |
| **item_number**                                    | Short text describing the node number like `1-1-A-1`         | User-entered                                                 | ‚úÖ Editable                                                   |
| **description**                                    | Short text describing the node                               | User-entered                                                 | ‚úÖ Editable                                                   |
| **short_description**                              | Optional brief description                                   | User-entered                                                 | ‚úÖ Editable                                                   |
| **name**                                           | Auto-generated composite name combining parent descriptions and item code | Calculated by system                                         | ‚ùå Not editable                                               |
| **order_in_parent**                                | Position/order of the node within its parent                 | Created automatically, editable for reordering               | ‚úÖ Editable                                                   |
| **lft**, **rgt**, **depth**, **nested_item_level** | Tree position indicators (nested set model)                  | Auto-calculated                                              | ‚ùå Not editable                                               |
| **created_at**, **updated_at**                     | Audit timestamps                                             | Auto-managed by system                                       | ‚ùå Not editable                                               |

---

### üîπ 3. Default Value Behavior

When a node (chapter, sub-chapter, or item) is first time created:

* **`sor_id`** = current active SOR ID.
* **`item_type`** = defined by creation type:

  * `1` ‚Üí Chapter
  * `2` ‚Üí Sub-chapter
  * `3` ‚Üí Item
* **`item_code`** =

  * `0` for chapters/sub-chapters.
  * Next available numeric code for items (unique within the SOR).
* **`order_in_parent`** = next integer value after the existing last child of that parent.
* **`name`** = generated automatically based on hierarchy and item code.
* **`item_number`** and **`description`** may be initiated as 'new_number', 'write description...' 

---

### üîπ 4. Hierarchy and Movement Constraints

Hierarchy integrity must always be preserved:

| Action                                                 | Allowed                                   | Notes |
| ------------------------------------------------------ | ----------------------------------------- | ----- |
| Move **item** ‚Üí to **chapter/sub-chapter/root**        | ‚úÖ Allowed                                 |       |
| Move **item** ‚Üí under **another item**                 | ‚ùå Not allowed                             |       |
| Move **chapter/sub-chapter** ‚Üí under **item**          | ‚ùå Not allowed                             |       |
| Move **chapter/sub-chapter/item** ‚Üí under valid parent | ‚úÖ Allowed if hierarchy remains consistent |       |

* **Items** are always **leaf nodes** (no children allowed).
* **Chapters** and **sub-chapters** can contain both sub-chapters and items.

---

### üîπ 5. Deletion Rules

Deletion must be controlled with checks and confirmation:

1. **Chapter/Sub-chapter Deletion**

   * Allowed **only if it has no child nodes**.
   * If it has sub-chapters, deletion should prompt a **confirmation warning**:

     > ‚ÄúDeleting this chapter will also delete all its sub-chapters. Continue?‚Äù
   * If it contains **items**, deletion is **not allowed** unless items are first removed.

2. **Item Deletion**

   * Allowed only if **not used** in other dependent tables (e.g., `sub_item` or `dependency` tables).
   * Must check dependencies before deletion.

3. **Confirmation Requirement**

   * Every deletion should trigger a **confirmation dialog** to prevent accidental data loss.

---

### üîπ 6. Summary of Editable Status

| Field                                 | Editable | Notes                          |
| ------------------------------------- | -------- | ------------------------------ |
| sor_id                                | ‚ùå        | Fixed at creation              |
| item_type                             | ‚ùå        | Fixed at creation              |
| parent_id                             | ‚úÖ        | Only if hierarchy rules permit |
| item_code                             | ‚ùå        | Fixed after creation           |
| description                           | ‚úÖ        | Always editable                |
| short_description                     | ‚úÖ        | Always editable                |
| name                                  | ‚ùå        | System-generated               |
| order_in_parent                       | ‚úÖ        | For reordering                 |
| lft / rgt / depth / nested_item_level | ‚ùå        | Auto-calculated                |
| created_at / updated_at               | ‚ùå        | System-managed                 |

---

